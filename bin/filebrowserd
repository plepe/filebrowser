#!/usr/bin/php
<?php include "conf.php"; /* load a local configuration */ ?>
<?php include "modulekit/loader.php"; /* loads all php-includes */ ?>
<?
function memorize_directory($archive_id, $archive_conf, $path) {
  global $db;

  $sqllite_archive_id=$db->escapeString($archive_id);
  $sqlite_path=$db->escapeString($path);
  $db->query("insert into directory (archive_id, path) values ('{$sqllite_archive_id}', '{$sqlite_path}')");
  $directory_id=$db->lastInsertRowID();

  print "* Memorizing $path => $directory_id\n";
  $d=opendir("{$archive_conf['path']}{$path}");
  while($f=readdir($d)) {
    if(substr($f, 0, 1)==".") ; // ignore hidden files
    else if(is_dir("{$archive_conf['path']}{$path}$f")) {
      memorize_directory($archive_id, $archive_conf, "{$path}{$f}/");
    }
    else {
      $sqlite_file=$db->escapeString($f);
      $db->query("insert into file (directory_id, filename) values ({$directory_id}, '{$sqlite_file}')");

      print "  $path: $f\n";
    }
  }
  closedir($d);

  return $directory_id;
}

unlink("{$cache}/new.db");
$db=new SQLite3("{$cache}/new.db");
$db->query(file_get_contents("init.sql"));

foreach($paths as $archive_id=>$archive_conf) {
  memorize_directory($archive_id, $archive_conf, "/");
}

$db->close();
rename("{$cache}/new.db", "{$cache}/db.db");
